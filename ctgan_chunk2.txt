# CTGAN HYPERPARAMETER OPTIMIZATION EXECUTION
# Run the actual optimization study with proper setup

print("ğŸ¯ Starting CTGAN Hyperparameter Optimization - CORRECTED PAC FIX")
print(f"   â€¢ Target column: '{TARGET_COLUMN}' (dynamic detection)")
print("   â€¢ ğŸ”§ CORRECTED FIX: Simplified PAC compatibility with runtime adjustment")
print("   â€¢ PAC values: [1, 2, 4, 8, 10, 16] with runtime compatibility checking")
print("   â€¢ Search space: 13 parameters")
print("   â€¢ Number of trials: 10")
print("   â€¢ Algorithm: TPE with median pruning")
print()

# Create the optimization study
ctgan_study = optuna.create_study(
    direction='maximize',
    pruner=optuna.pruners.MedianPruner(n_startup_trials=5, n_warmup_steps=2)
)

# Run the optimization
try:
    # Ensure we have the required global variables
    if 'data' not in globals():
        raise ValueError("âŒ Data not available - please run data loading sections first")
        
    if 'TARGET_COLUMN' not in globals():
        TARGET_COLUMN = 'outcome'  # fallback
        print(f"âš ï¸  TARGET_COLUMN not set, using fallback: '{TARGET_COLUMN}'")
    
    print(f"ğŸ“Š Dataset info: {data.shape[0]} rows, {data.shape[1]} columns")
    print(f"ğŸ“Š Target column '{TARGET_COLUMN}' unique values: {data[TARGET_COLUMN].nunique()}")
    print()
    
    # Run the optimization trials
    ctgan_study.optimize(ctgan_objective, n_trials=10, timeout=3600)  # 1 hour timeout
    
    # Display results
    print(f"\nğŸ“Š CTGAN hyperparameter optimization with corrected PAC compatibility completed!")
    print("ğŸ¯ No more dynamic parameter name issues - simplified and robust approach")
    
    # Best trial information
    best_trial = ctgan_study.best_trial
    print(f"\nğŸ† Best Trial Results:")
    print(f"   â€¢ Best Score: {best_trial.value:.4f}")
    print(f"   â€¢ Trial Number: {best_trial.number}")
    print(f"   â€¢ Best Parameters:")
    for key, value in best_trial.params.items():
        print(f"     - {key}: {value}")
    
    # Summary statistics
    completed_trials = [t for t in ctgan_study.trials if t.state == optuna.trial.TrialState.COMPLETE]
    failed_trials = [t for t in ctgan_study.trials if t.state == optuna.trial.TrialState.FAIL]
    
    print(f"\nğŸ“ˆ Optimization Summary:")
    print(f"   â€¢ Total trials completed: {len(completed_trials)}")
    print(f"   â€¢ Failed trials: {len(failed_trials)}")
    if completed_trials:
        scores = [t.value for t in completed_trials]
        print(f"   â€¢ Best score: {max(scores):.4f}")
        print(f"   â€¢ Mean score: {sum(scores)/len(scores):.4f}")
        print(f"   â€¢ Score range: {max(scores) - min(scores):.4f}")
    
    # Store results for Section 4.1.1 analysis
    ctgan_optimization_results = {
        'study': ctgan_study,
        'best_trial': best_trial,
        'completed_trials': completed_trials,
        'failed_trials': failed_trials
    }
    
    print(f"\nâœ… CTGAN optimization data ready for Section 4.1.1 analysis")
    
except Exception as e:
    print(f"âŒ CTGAN hyperparameter optimization failed: {str(e)}")
    print(f"ğŸ” Error details: {repr(e)}")
    import traceback
    traceback.print_exc()
    
    # Create dummy results for analysis to continue
    ctgan_study = None
    ctgan_optimization_results = None
    print("âš ï¸  CTGAN optimization failed - Section 4.1.1 analysis will show 'data not found' message")
